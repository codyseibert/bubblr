<!DOCTYPE html>
<meta charset="utf-8">

<style>
    html, body {
        margin: 0;
        padding: 0;
    }

    #box {
        width: 100%;
        height: 100%;
    }

    .node {
        fill: green;
    }

    .node .text{
        color: red;
    }

    .text {
        color: orange;
    }

    .cursor {
        fill: none;
        stroke: brown;
        pointer-events: none;
    }

    .link {
        stroke: #999;
    }

</style>

<body>
    <div id="box"></div>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

        var w = 500,
            h = 500,
            m = [40, 240, 40, 240];

        //var color = d3.scale.category10();

        var force = d3.layout.force()
            .charge(-1000)
            .linkDistance(120)
            .size([w, h])
            .on("tick", tick);

        var nodes = force.nodes();
        var links = force.links();

        var drag = force.drag()
            .on("dragstart", dragstart)
            .on("dragend", dragend);

        var vis = d3.select("#box").append("svg:svg")
                .attr("class","svg_container")
                .style("overflow", "scroll")
                .style("background-color","#EEEEEE")
                .attr("viewBox", "0 0 " + w + " " + h)
                .attr("preserveAspectRatio", "xMidYMid meet")
            .append("svg:g")
                .attr("class", "drawarea")
            .append("svg:g")
                .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

        // var svg = d3.select("#box").append("svg")
        //     .attr("class","svg_container")
        //     .attr("viewBox", "0 0 " + width + " " + height )
        //     .attr("preserveAspectRatio", "xMinYMin")
        //     .call(d3.behavior.zoom()
        //             .scaleExtent([0.5, 5])
        //             .on("zoom", zoom));

        // var node = vis.selectAll(".node"),
        //     link = vis.selectAll(".link");

        d3.select("svg")
            .call(
                d3.behavior.zoom()
                .on("zoom", zoom)
            ).on("dblclick.zoom", null);

        function createNode () {
            return {
                id: guid(),
                x: Math.random()*400,
                y: Math.random()*400
            }
        };

        nodes.push(createNode());
        start();

        function start() {
            var link = vis.selectAll(".link").data(force.links(), function(d) {
                return d.source.id + "-" + d.target.id;
            });
            link.enter()
                .insert("line", ".node")
                .attr("class", "link");
            link.exit().remove();

            var node = vis.selectAll(".node").data(force.nodes(), function(d) {
                return d.id;
            });
            node.enter()
                .append("svg:circle")
                .attr("r", 8)
                .attr("class", "node")
                .on("dblclick", dblclick)
                .on("click", click)
                .text(function(d) {
                    return d.id + ""
                })
                .call(drag);

            node.append("svg:text")
                .attr("class", "text")
                .attr("dx", 12)
                .attr("dy", ".35em")
                .text(function(d) {
                    return "testing";
                });
            node.exit().remove();

            force.start();
        }

        function tick() {
            vis.selectAll(".node")
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })

            vis.selectAll(".link")
                .attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });
        }

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
            s4() + '-' + s4() + s4() + s4();
        }

        function click(d) {

        }

        function dblclick(d) {
            var newNode = createNode();
            nodes.push(newNode);

            links.push({
                source: newNode,
                target: d
            })

            start();
        }

        function dragstart(d) {
            d3.select(this).classed("fixed", d.fixed = true);
        }

        function dragend(d) {
            d3.select(this).classed("fixed", d.fixed = false);
        }

        function zoom() {
            var scale = d3.event.scale,
                translation = d3.event.translate,
                tbound = -h * scale,
                bbound = h * scale,
                lbound = (-w + m[1]) * scale,
                rbound = (w - m[3]) * scale;
                // limit translation to thresholds
                // translation = [
                //     Math.max(Math.min(translation[0], rbound), lbound),
                //     Math.max(Math.min(translation[1], bbound), tbound)
                // ];
            d3.select(".drawarea")
                .attr("transform", "translate(" + translation + ")" + " scale(" + scale + ")");
        }
    </script>
</body>
